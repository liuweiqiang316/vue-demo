<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Vue</title>
</head>

<body>
  <div id="msg"></div>
</body>
<script>
  /**
   * 准备工作
  */

  const bucket = new WeakMap()

  const cleanup = (effectFn) => {
    for (let i = 0; i < effectFn.deps.length; i++) {
      const deps = effectFn.deps[i]
      deps.delete(effectFn)
    }
    effectFn.deps.length = 0
  }

  let activeEffect
  // effect 栈
  const effectStack = []

  const effect = (fn) => {
    const effectFn = () => {
      cleanup(effectFn)
      activeEffect = effectFn
      effectStack.push(effectFn)
      fn()
      effectStack.pop()
      activeEffect = effectStack[effectStack.length - 1]
    }
    effectFn.deps = []
    effectFn()
  }

  const track = (target, key) => {
    if (!activeEffect) return

    let despMap = bucket.get(target)
    if (!despMap) {
      bucket.set(target, (despMap = new Map()))
    }

    let deps = despMap.get(key)
    if (!deps) {
      despMap.set(key, (deps = new Set()))
    }

    deps.add(activeEffect)
    activeEffect.deps.push(deps)
  }

  const trigger = (target, key) => {
    const despMap = bucket.get(target)
    if (!despMap) return

    const effects = despMap.get(key)

    const effectsToRun = new Set()

    effects && effects.forEach(effectFn => {
      if (effectFn !== activeEffect) {
        effectsToRun.add(effectFn)
      }
    })


    effectsToRun.forEach(fn => fn())
  }

  /**
   * 调用示例
  */

  const data = { foo: 1 }

  const proxy = new Proxy(data, {
    get(target, key) {
      track(target, key)

      return target[key]
    },
    set(target, key, newVal) {
      target[key] = newVal
      trigger(target, key)
    }
  })

  effect(() => {
    proxy.foo++
  })


</script>

</html>